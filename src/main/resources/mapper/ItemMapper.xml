<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.app.mapper.ItemMapper">

	<resultMap id="ItemResultMap"
		type="com.example.app.domain.Item">
		<id property="id" column="id" />
		<result property="userId" column="user_id" />
		<result property="festivalId" column="festival_id" />
		<result property="festivalName" column="festival_name" />
		<result property="itemName" column="item_name" />
		<result property="category" column="category" />
		<result property="quantity" column="quantity" />
		<result property="createdAt" column="created_at" />
		<result property="updatedAt" column="updated_at" />
	</resultMap>


	<!-- 全件取得 -->
	<select id="findAll" resultMap="ItemResultMap">
		SELECT
		i.id,
		i.user_id,
		i.festival_id,
		i.item_name,
		i.category,
		i.quantity,
		i.created_at,
		i.updated_at,
		f.fes_name AS festival_name
		FROM item i
		LEFT JOIN festival
		f ON i.festival_id = f.id
	</select>

	<!-- 条件検索 -->
	<select id="search" resultMap="ItemResultMap">
		SELECT
		i.id,
		i.user_id,
		i.festival_id,
		i.item_name,
		i.category,
		i.quantity,
		i.created_at,
		i.updated_at,
		f.fes_name AS festival_name
		FROM item i
		LEFT
		JOIN festival f ON i.festival_id = f.id
		<where>
			<if test="category != null and category != ''">
				AND i.category = #{category}
			</if>
			<if test="festivalId != null">
				AND i.festival_id = #{festivalId}
			</if>
		</where>
	</select>

	<!-- 主キーで1件取得 -->
	<select id="findById" resultMap="ItemResultMap">
		SELECT * FROM item
		WHERE id
		=#{id}
	</select>

	<!-- 新規登録 -->
	<insert id="insert" parameterType="com.example.app.domain.Item">
		INSERT INTO item(
		user_id,festival_id,item_name,category,quantity,created_at,updated_at)
		VALUES
		(#{userId},#{festivalId},#{itemName},#{category},#{quantity},#{createdAt},#{updatedAt})
	</insert>

	<!-- 更新 -->
	<update id="update" parameterType="com.example.app.domain.Item">
		UPDATE item
		SET user_id =
		#{userId},
		festival_id = #{festivalId},
		item_name = #{itemName},
		category = #{category},
		quantity = #{quantity},
		updated_at =#{updatedAt}
		WHERE id =#{id}
	</update>

	<!-- 削除 -->
	<delete id="delete" parameterType="long">
		DELETE FROM item WHERE id
		=#{id}
	</delete>

	<!-- ページネーション：全件 -->
	<select id="countItems" resultType="int">
		SELECT COUNT(*) FROM item
	</select>


	<select id="findItemByPage" resultMap="ItemResultMap">
		SELECT
		i.id,
		i.user_id,
		i.festival_id,
		i.item_name,
		i.category,
		i.quantity,
		i.created_at,
		i.updated_at,
		f.fes_name AS festival_name
		FROM item i
		LEFT JOIN festival
		f ON i.festival_id =f.id
		ORDER BY i.id
		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!-- ページネーション：検索つき -->
	<select id="countSearchItems" resultType="int">
		SELECT COUNT(*) FROM
		item
		WHERE (#{category} IS NULL OR category = #{category})
		AND
		(#{festivalId} IS NULL OR festival_id = #{festivalId})
	</select>

	<select id="searchByPage"
		resultType="com.example.app.domain.Item">
		SELECT
		i.id, i.user_id, i.festival_id, i.item_name,
		i.category, i.quantity,
		i.created_at, i.updated_at,
		f.fes_name AS
		festival_name
		FROM
		item i
		LEFT JOIN festival f ON i.festival_id = f.id
		WHERE
		(#{category} IS NULL OR i.category = #{category})
		AND
		(#{festivalId} IS NULL OR
		i.festival_id = #{festivalId})
		ORDER BY i.id
		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!-- 条件に一致した item だけ返す“厳格”版 -->
	<select id="selectSuggestedItems" resultMap="ItemResultMap">
  <![CDATA[
  SELECT DISTINCT
    i.id, i.user_id, i.festival_id, i.item_name, i.category, i.quantity,
    i.created_at, i.updated_at,
    f.fes_name AS festival_name
  FROM item i
  JOIN item_condition c ON c.item_id = i.id           -- ★ LEFT → JOIN（必須）
  LEFT JOIN festival f ON i.festival_id = f.id
  WHERE
    (c.festival_id IS NULL OR c.festival_id = #{festivalId})
    AND (c.min_days   IS NULL OR #{days} >= c.min_days)
    AND (c.max_days   IS NULL OR #{days} <= c.max_days)
    AND (c.lodging    IS NULL OR c.lodging = #{lodging})
    AND (c.gender     IS NULL OR c.gender = 'any' OR c.gender = #{gender})
  ORDER BY i.category, i.item_name
  ]]>
	</select>


</mapper>